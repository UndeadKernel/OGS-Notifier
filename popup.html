<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.6.4/jquery.min.js"></script>
<script type="text/javascript" src="functions.js"></script>
<link rel="stylesheet" type="text/css" href="style.css" />

<div class='content-wrapper'>
    <div id="login-wrapper">

        <span class='alert'>Error: not logged in</span>

        <fieldset class="menulogin">
            <legend>Login</legend>

            <table>
                <tr>
                    <td> <label style="float:left;">User</label> </td>
                    <td>
                        <div class="menulogin">
                            <input type="text" name="userName" value="" id="username" class="menulogin"/>
                            <input type="hidden" name="validLoginAttempt" value="1" />
                        </div>
                    </td>
                </tr>
                <tr>
                    <td> <label style="float:left;">Password</label> </td>
                    <td>
                        <div class="menulogin">
                            <input type="password" name="passWord" id="password" value="" class="menulogin"/>
                        </div>
                    </td>
                </tr>
                <tr>
                    <td>
                        <input id='submit' style="width:100%; margin: 10px 0;" type="submit" value="Log In" />
                    </td>
                    <td style="text-align:right;">
                        <a class="main" href="javascript:gotoLogin();">Open Login Page</a>
                    </td>
                </tr>
            </table>

            <div style="display:none;" id="message"></div>

        </fieldset>
    </div>

    <div style="display:none;" id="remote-information">
        <a id="mygames-link" style="text-align:center; display:block; margin-bottom:10px;">Go to mygames</a>
        <div id="games-injection"></div>
    </div>

</div> <!-- content-wrapper -->

<script>

    var root = localStorage['url'];
    var view = localStorage['include_viewed'] == 'on' ? "" : "?only_unviewed=true";

    function gotoLogin() {
        chrome.tabs.create( {url: root+"/login.php"} );
    }

    // check if loggged in
    var response;

    if (localStorage['logged-in'] === 'false') {

        $('#login-wrapper').show();

        // on submission, create a new tab, send the login information
        $('#submit').click( function(event) {

            $.ajax({
                type: 'POST',
                url: root+"/includes/functions/ajax/login.php",
                data: {passWord: $('#password').attr("value"), userName: $('#username').attr("value")},
                success: function(response){
                    if (response == 'ok') {
                        localStorage['logged-in'] = true;
                        update();
                    }
                    $('#message').html(response);
                    $('#message').show();
                    setTimeout( function() { $('#message').hide();} , 5000);
                }
            });

            event.stopPropagation();
        });

    } else {

    // clear the results container
    $('#remote-information').show();
    $('#games.injection').html("");
    $('#login-wrapper').hide();

    $('#mygames-link').attr('href', root + "/games/mygames.php").click( function() {
        chrome.tabs.create( {url: $(this).attr('href') } );
    });


    // download the game/message information from the notifier
    var notifierURL = root+"/games/xmlnotifier.php?format=json";
    /*
    {
        "id"           : "305567",
        "opponentName" : "betterlife",
        "deadline"     : "2011-09-29T13:35:33",
        "name"         : "OGS Tianyuan 2010 (Main Class), Round 2 Group 3",
        "size"         : "19",
        "ruleset"      : "Chinese",
        "toMove"       : "1"
    } */

    // download and parse the game information
    $.get(notifierURL, function(data) {
        var games    = data.games;
        var messages = data.messages;

        var gameTable  = create('table')
        .append( create('tr')
                .append(
                    create('td').html("")
                )
                .append(
                    create('td').html("Opponent")
                ).addClass('rowh')
                .append(
                    create('td').html("Deadline")
                )
        );

        // inject each game into the DOM
        for (var i = 0; i < games.length; i++) {

            var gameRow = create('tr');

            // put the link in the row's rel attribute so that it can be accessed from the click() function
            gameRow.attr('rel', root + "/games/board.php?boardID=" + games[i].id);

            gameRow.click( function() {
                chrome.tabs.create( {url: $(this).attr('rel') } );
            });

            // Extract the date in milliseconds since epoch
            var dt  = new Date(games[i].deadline.replace("T", " ") + " UTC" ).getTime();

            // Express the time until the deadline in seconds
            dt = (dt - new Date().getTime() ) / 1000;

            var days  = Math.floor(dt / (3600 * 24) ); dt -= days  * 3600 * 24;
            var hours = Math.floor(dt / (3600)      ); dt -= hours * 3600;
            var mins  = Math.floor(dt / (60)        );

            // Construct a plain-text description of the time until the deadline
            var remaining = "";
            if (days  > 0) remaining += days + "d";
            remaining += " " + hours + "h";
            if (days == 0) remaining += "  " + mins + "m";

            // make the board reference bold if it's unviewed
            if (games[i].viewed === "0")
                gameRow.addClass('unviewed');

            // Create table elements containing the data
            gameRow
            .append(
                create('td').html(i+1)
            )
            .append(
                create('td').html(remaining)
            )
            .append(
                create('td').html(games[i].opponentName)
            );

            gameRow.addClass( 'row' + (i % 2) );
            gameTable.append( gameRow );

            // uncomment below to test very long lines
            //gameTable.append( create('tr').append( create('td').attr('colspan', '3').html("junk") ) );

        } // for ( ... games ... )

        // append the game table to the dom
        gameTable.attr('id','games');
        $('#games-injection').append(gameTable);

        // detect scrollbars and set the width accordingly.  Chrome limits popups to 600px height, 800px width
        $('#games').ready( function() {
            var db = document.body;
            var sw = (db.scrollHeight < 600) ? 0 : db.clientWidth - db.offsetWidth;
            $('body').css('padding-right', sw + 'px');
        });

        }, "json"); // $.get(...

    } // if logged in

</script>


<!-- do XML parsing -->
